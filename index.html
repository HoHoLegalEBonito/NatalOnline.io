<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snowman Online Battle</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; }
        #score-ui { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; pointer-events: none; }
    </style>
</head>
<body>

<div id="score-ui">Doces: <span id="score">0</span></div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';
    // PlayroomKit: O "jeito fácil" que cria o online sem servidor
    import { insertCoin, myPlayer, onPlayerJoin, useJoystick } from "https://unpkg.com/playroomkit/dist/index.js";

    async function start() {
        // 1. INICIALIZAR O ONLINE (Isso abre a tela de lobby automaticamente)
        await insertCoin();

        // --- SETUP SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.OrthographicCamera(-12 * (window.innerWidth/window.innerHeight), 12 * (window.innerWidth/window.innerHeight), 12, -12, 1, 1000);
        camera.position.set(20, 20, 20);
        camera.lookAt(0, 0, 0);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 20, 10);
        scene.add(light, new THREE.AmbientLight(0xffffff, 0.7));

        // --- CENÁRIO ---
        const island = new THREE.Mesh(new THREE.CylinderGeometry(15, 15, 1, 32), new THREE.MeshPhongMaterial({ color: 0xffffff }));
        island.position.y = -0.5;
        scene.add(island);

        // Prisão (Bola flutuante)
        const prison = new THREE.Mesh(new THREE.SphereGeometry(2.5, 32, 32), new THREE.MeshPhongMaterial({ color: 0xadd8e6, transparent: true, opacity: 0.4 }));
        prison.position.y = 8;
        scene.add(prison);

        // --- LÓGICA DE JOGADORES ---
        const players = [];
        const createSnowman = (color) => {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.SphereGeometry(0.6, 12, 12), new THREE.MeshPhongMaterial({ color }));
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.4, 12, 12), new THREE.MeshPhongMaterial({ color }));
            head.position.y = 0.8;
            g.add(body, head);
            scene.add(g);
            return g;
        };

        // Quando alguém entra (inclusive você)
        onPlayerJoin((playerState) => {
            const snowman = createSnowman(playerState.getProfile().color.hex);
            const joystick = useJoystick(playerState); // Joystick automático para celular!
            
            players.push({ state: playerState, mesh: snowman, joystick });
            
            playerState.onQuit(() => {
                scene.remove(snowman);
                players.splice(players.indexOf(playerState), 1);
            });
        });

        // Carregar pontos do LocalStorage
        let myScore = parseInt(localStorage.getItem('snowman_candy')) || 0;
        document.getElementById('score').innerText = myScore;

        // --- LOOP PRINCIPAL ---
        function animate() {
            requestAnimationFrame(animate);

            players.forEach(({ state, mesh, joystick }) => {
                // Se for o MEU boneco
                if (state === myPlayer()) {
                    const d = joystick.getValues();
                    if (d.x !== 0 || d.y !== 0) {
                        mesh.position.x += d.x * 0.15;
                        mesh.position.z -= d.y * 0.15; // Invertido para o joystick
                    }
                    // Salva posição na rede para os outros verem
                    state.setState("pos", { x: mesh.position.x, z: mesh.position.z });
                } else {
                    // Se for OUTRO player, só atualiza a posição que vem da rede
                    const pos = state.getState("pos");
                    if (pos) {
                        mesh.position.lerp(new THREE.Vector3(pos.x, 0, pos.z), 0.2);
                    }
                }
            });

            renderer.render(scene, camera);
        }
        animate();
    }

    start();
</script>
</body>
</html>
